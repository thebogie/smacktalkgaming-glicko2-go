[[template "header.html" .]]
	<script>
	var app = angular.module( 'smacktalk-get' ,  ['ui.bootstrap', 'ui.sortable'] );
	var URLplayerslistautocomplete = [[url "Players.ListAutoComplete"]];
	var URLgameslistautocomplete = [[url "Games.ListAutoComplete"]];
	var URLeventstatus = [[url "Events.Status"]];
	
	</script>
  	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true&libraries=places&language=en-US"></script>
  	<script type="text/javascript" src="/public/js/app/directives/lists.js"></script>
	<script type="text/javascript" src="/public/js/app/directives/httpFactory.js"></script>
	
	<script type="text/javascript" src="/public/js/app/controllers/gamelistctrl.js"></script>
	<script type="text/javascript" src="/public/js/app/controllers/playerlistctrl.js"></script>
	<script type="text/javascript" src="/public/js/app/controllers/locationlistctrl.js"></script>	
	

	<style>
	.item, .placeholder {
	    padding: 2px;
	    width: 50px;
	    height: 20px;
	    border: 1px solid #333;
	    background: #EEE;
	}
	.placeholder {
	    background: #AEF;
	}
	
	</style>
</header>
<body>
 <div data-ng-app="smacktalk-get" >
  <div data-ng-controller="EventCtrl" ng-cloak >

	<div  data-ng-show="showPage1" class='container-fluid' data-ng-controller="PlayerListCtrl">
	   	<h4>List of Players in Event</h4>
	    <input type="text" ng-model="currentplayerlist" placeholder="Choose Players in Event" 
			typeahead="player as player.selectName for player in updateList($viewValue)" 
			typeahead-loading="loadingPlayers" 
		 	typeahead-on-select='onSelect($item, $model, $label); currentplayerlist =""; '
		>
	    <i ng-show="loadingPlayers" class="glyphicon glyphicon-refresh"></i>
		
		<ul id="currentplayerlist"> 
			<li> Number of Players: {{numplayers}}</li>
			<li data-ng-repeat="currentplayer in activelist">
				<a data-ng-click="removeItem(currentplayer.UUID)">{{currentplayer.Firstname}} {{currentplayer.Surname}}</a>
			</li>
		</ul>
		<hr>
	</div>



 

	<div data-ng-show="showPage1" class='container-fluid' data-ng-controller="GameListCtrl">
	   	<h4>Games</h4>
	    <input type="text" ng-model="currentgamelist" placeholder="Game to be played" 
			typeahead="game as game.selectName for game in updateList($viewValue)" 
			typeahead-loading="loadingGames" 
		 	typeahead-on-select='onSelect($item, $model, $label); currentgamelist =""; '
		>
	    <i ng-show="loadingGames" class="glyphicon glyphicon-refresh"></i>
	
		<ul id="currentgamelist"> 
			<li data-ng-repeat="currentgame in activelist">
				<a data-ng-click="removeItem(currentgame.UUID)">{{currentgame.Name }} {{currentgame.Published }}</a>
			</li>
		</ul>
	<hr>
	</div>



	<div data-ng-show="showPage1" class='container-fluid' data-ng-controller="LocationListCtrl">
	   	<h4>Location</h4>
		
   	 	<div><input  ng-model="chosenPlace" googleplace/></div>
		<div>selection is: {{chosenPlace}}</div>


	<hr>
	</div>

    <div>
       <input data-ng-show="showPage1" type="button" value="Start Event!" data-ng-click="startEvent()" >
	</div>
	
	
	<!-- event timer page -->
	<div data-ng-show="showPage2" data-ng-controller="EventTimerCtrl" >
		<h4>{{eventname}}</h4>
	 	
		<table>
			<!-- 
			 <tr data-ng-repeat="x in playerlist">
	    		<td>{{ x.Firstname }} {{ x.Surname }}</td>
	  		</tr> 		
			-->
			<tr><td>Games:</td></tr>
	  		<tr data-ng-repeat="x in gamelist">
	    		<td>{{ x.Name }} {{ x.Published }}</td>
	  		</tr>
			<tr><td>At</td></tr>
			<tr data-ng-repeat="x in locationlist">
	    		<td>{{ x.Locationname }}</td>
	  		</tr>
			
		</table> 
		
		

		
		
		<hr>

		start: {{starttime.toString()}}
		<br/>
		{{currenttime}}
	
		<hr>

    
   		<div class="container-fluid">
	  		<div class="row">    
	    		<table 	class="table table-bordered table-condensed"   
		       			as-sortable="sortableOptions"  ng-model="playerlist">
		     
			<thead>
				<tr >
	   				<th>Player</th>
	   				<th>Result</th>
					<th>Place</th>
	 			</tr>
			</thead>
			<tbody>
	        	<tr    ng-repeat="player in playerlist" as-sortable-item class="as-sortable-item">
	            	<td as-sortable-item-handle class="as-sortable-item-handle" >
	                       <span data-ng-bind="player.selectName"></span>
	           		</td>
					<td >
						
		 				<select ng-init="chosenresult = SetInitResult($index)" ng-change="updatePlayerResult(chosenresult,$index)" 
						        ng-options="result for result in possibleresults" ng-model="chosenresult"></select>
					</td>
					<td >
					<!--
					    <select ng-model="chosenplace">
							<option ng-init="chosenplace = ($index+1).toString()"  ng-repeat="obj in playerlist" value="{{obj.playedin.Place}}">
      						{{obj.playedin.Place}}
    						</option>
						</select>
						-->
						
					
						<select  ng-init="chosenplace = ($index+1).toString()" ng-change="updatePlayerPlace(chosenplace,$index)"    
								 ng-options="place for place in possibleplaces" ng-model="chosenplace">
						
						</select>
						
					</td>
	        	</tr>
			</tbody>
	    		</table>
	        </div>
		</div>
	<hr>



<div>
       		<input  type="button" value="Cancel Event" data-ng-click="cancelEvent()" >
		</div><div>
       		<input  type="button" value="Commit Event" data-ng-click="commitEvent(eventUUID)" >
		</div>

	</div>
	
</div> <!-- end of all object -->

<Script>


app.controller( 'EventTimerCtrl' , ['$scope', 'Lists', 'myHttpFactory', '$interval', function( $scope , Lists , myHttpFactory, $interval) {
	
	
	$scope.eventname = "FISH";
	$scope.starttime  = "000";
	$scope.eventUUID = "";
	
	//TODO make this a http get to get the servers definitions
	$scope.possibleresults = [ "DEMOLISH", "WON" , "TIE", "LOST", "SKUNK", "DROP", "QUIT", "RAGE QUIT" ];
	$scope.possibleplaces = [ "1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20" ];

	$scope.gamelist = Lists.getList("gameList");
	$scope.playerlist = Lists.getList("playerList");
	$scope.locationlist = Lists.getList("locationList");
	
	$scope.updatePlayerResult = function(item,index) {
		console.log("resultchange" + item + " " + index);
		Lists.setPlayerResult(index, item);
		//Lists.updateList("playerList");
	};
	
	$scope.updatePlayerPlace = function(item,index) {
		console.log("placechange" + item + " " + index + "SCOPE" + $scope.chosenplace);
		Lists.setPlayerPlace(index, item);
		//Lists.updateList("playerList");
	};
	
	$scope.SetInitResult = function(index) {
		console.log("choiceresult" + $scope.chosenresult+ index);
		if (index < 1) {
			Lists.setPlayerResult(index, "WON");
			return "WON";
		}
		Lists.setPlayerResult(index, "LOST");
		return "LOST";
	};
	
	$scope.SetInitPlace = function(index) {
		
		//$scope.chosenplace = (index+1).toString();
		$scope.chosenplace =  $scope.playerlist[index].playedin["Place"];
		console.log("chosenplace" + $scope.choseplace+ index+ ":" +  $scope.playerlist[index].playedin["Place"]);
		//TODO why is this not working?
		//console.log((index+1).toString());
		
	};

  $scope.updatePlaces = function(){
	console.log("UPDATEPLACE");
		Lists.orderList("playerList");
		console.log("choseplace" + $scope.chosenplace );
	
			templist = Lists.getList("playerList");
		for (var i = 0; i < templist.length; i++) {
			$scope.chosenplace[i] = templist[i];
			console.log("choseplace" + $scope.chosenplace[i] );
			console.log("templist" +  templist[i]);
				   
		}
	
	};
	
  $scope.sortableOptions = {
	
	accept: function (sourceItemHandleScope, destSortableScope) {
		console.log("Accept");
		return true},
    itemMoved: function (event) {
		console.log("itemMoved");
		
			
	},
    orderChanged: function(event) {
	
		console.log("orderchanged" + event.dest.index);
		console.log("orderchanged" + event.source.index);
		console.log("orderchanged scope?" +event.source.itemScope.chosenplace);
		//console.log("orderchanged dest scope?" + JSON.stringify(event.source, null, 4)) ;
		
		
		event.source.itemScope.chosenplace = (event.dest.index+1).toString();
		Lists.orderList("playerList");
		//if ( event.dest.index == 0) {
		//	 $scope.chosenresult = Updater.updateResult("FISH");
		//} else {
		//	$scope.chosenresult = "LOSE";
		//}
		//$scope.chosenplace = (event.dest.index+1).toString();
	
		
	},
	
    containment: '#sortable-container'
  };

	$interval(function(){
	
        seconds = Math.floor((new Date() - ($scope.starttime))/1000);
        minutes = Math.floor(seconds/60);
        hours = Math.floor(minutes/60);
        days = Math.floor(hours/24);
        
        hours = hours;
        minutes = minutes-(hours*60);
        seconds = seconds-(hours*60*60)-(minutes*60);
		
		$scope.currenttime = "Game running time: " + hours + ":" + minutes + ":" + seconds;
		
	},1000);

	

	$scope.$on('ShowPage2EventFromEventCtrl',function(event,  UUID){
			
			$scope.eventUUID = UUID;
			myHttpFactory.getEvent(UUID).then(function(data) {
				
				$scope.locationlist = Lists.getList("locationList");
				//alert("HERE" + JSON.stringify(data));
				$scope.eventname = data.Eventname;
				$scope.starttime = new Date(data.Start);
				

			
					

			});
			
			
          

    });
	
}]);


app.controller( 'EventCtrl' , ['$http', '$window', '$scope', 'Lists', 'myHttpFactory' , function( $http, $window, $scope , Lists, myHttpFactory) {
	//TODO VALIDATION CODE HERE
	$scope.showPage1 = true;
	$scope.showPage2 = false;
	$scope.showPage3= false;
	
	$scope.eventname = "FISH";
	$scope.eventUUID = "TOAD";
	
	$scope.startEvent = function () {
		
		var eventcargo = {players: [], games:[], locations:[]};
		
		eventcargo.players = Lists.getList("playerList");
		eventcargo.games = Lists.getList("gameList");
		eventcargo.locations = Lists.getList("locationList");
		myHttpFactory.httpstartEvent(eventcargo).then(function(results) {
			
			$scope.showPage1 = false;
			$scope.showPage2 = true;
			//console.log("data:"  +JSON.stringify(results));
			//console.log("status:"  +status);
			//console.log("headers:"  +headers);
			//console.log("config:"  +config);
			
			$scope.$broadcast( "ShowPage2EventFromEventCtrl", results.data.UUIDEvt );

		});
		
	}

	$scope.commitEvent = function (eventUUID) {
		
		//get playerlist

		currentplayerlist = Lists.getList("playerList");

		console.log("UUUID" + eventUUID);
		console.log("stoptime" + new Date() );

		
		var eventcargocommit = {
			eventuuid:eventUUID,
			players: currentplayerlist,
			playedin: [],
				
		};
		
		console.log("JSON DUMP" + JSON.stringify(eventcargocommit));
		
		for (var i = 0; i < currentplayerlist.length; i++) {
			console.log("name" + currentplayerlist[i].Firstname);
			console.log("Result" + currentplayerlist[i].playedin["Result"]);
			console.log("Place" + currentplayerlist[i].playedin["Place"]);
			var playedinObj = { Result:"", Place:""};
			playedinObj.Result = currentplayerlist[i].playedin["Result"];
			playedinObj.Place = currentplayerlist[i].playedin["Place"];
			eventcargocommit.playedin[i] =playedinObj;
				   
		}
		
		myHttpFactory.httpcommitEvent(eventcargocommit).then(function(results) {
			

			
			
			//$scope.showPage1 = false;
			//$scope.showPage2 = true;
			//console.log("data:"  +JSON.stringify(results));
			//console.log("status:"  +status);
			//console.log("headers:"  +headers);
			//console.log("config:"  +config);
			
			//$scope.$broadcast( "ShowPage2EventFromEventCtrl", results.data.UUIDEvt );

		});
		//alert("CINNUT INCOKETE");
		$window.location.href = "/";
		
	}
	
	$scope.cancelEvent = function () {
		
			//TODO remove event from database!
			//myHttpFactory.httpremoveEvent
			
			$scope.showPage1 = true;
			$scope.showPage2 = false;

		
	}
	
	}]);

</script>
[[template "footer.html" .]]